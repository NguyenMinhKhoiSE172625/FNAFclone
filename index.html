<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Night Shift - Prototype V8 (Freddy & Golden Freddy)</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; color: white; font-family: 'Courier New', Courier, monospace; user-select: none; }
        
        #vignette { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, transparent 30%, rgba(0,0,0,0.95) 90%); pointer-events: none; z-index: 40; }
        #static-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('data:image/svg+xml,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)" opacity="0.05"/%3E%3C/svg%3E'); pointer-events: none; z-index: 41; opacity: 0.5;}
        
        /* Hi·ªáu ·ª©ng nhi·ªÖu s√≥ng m·∫°nh cho Golden Freddy Jumpscare */
        .heavy-static { opacity: 0.8 !important; animation: flicker 0.1s infinite !important; z-index: 999 !important; background-color: #111;}
        @keyframes flicker { 0% { opacity: 0.8; } 50% { opacity: 0.4; } 100% { opacity: 0.9; } }

        /* Start Screen */
        #start-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 200; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        #start-screen h1 { font-size: 50px; color: #a00; text-shadow: 0 0 10px red; margin-bottom: 0;}
        #start-night-display { font-size: 24px; color: #aaa; margin-bottom: 30px; }
        .menu-btn { background: none; border: 2px solid #555; color: white; padding: 15px 30px; font-size: 20px; font-family: inherit; cursor: pointer; transition: 0.2s; margin: 10px; width: 250px;}
        .menu-btn:hover { background: white; color: black; font-weight: bold;}

        /* HUD & Monitor Toggle */
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .top-right { position: absolute; top: 20px; right: 30px; text-align: right; font-size: 24px; text-shadow: 2px 2px 0 #000; }
        .bottom-left { position: absolute; bottom: 30px; left: 30px; font-size: 20px; text-shadow: 2px 2px 0 #000; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px;}
        #cam-toggle { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 400px; height: 40px; background: rgba(255,255,255,0.1); border: 2px solid #555; border-bottom: none; color: #aaa; cursor: pointer; pointer-events: auto; font-size: 18px; transition: 0.2s; border-radius: 10px 10px 0 0; z-index: 101;}
        #cam-toggle:hover { background: rgba(255,255,255,0.3); color: white; height: 45px;}

        /* Office */
        #viewport { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        #office { position: absolute; top: 0; left: 0; width: 160vw; height: 100%; background: linear-gradient(to right, #050505, #151515, #151515, #050505); transition: transform 0.1s ease-out; display: flex; justify-content: space-between; align-items: center;}
        
        .wall-texture { position: absolute; width: 100%; height: 80%; top: 0; background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.2) 0px, rgba(0,0,0,0.2) 2px, transparent 2px, transparent 4px); pointer-events: none; opacity: 0.3;}
        .floor { position: absolute; bottom: 0; left: 0; width: 100%; height: 20%; background: repeating-linear-gradient(45deg, #151515, #151515 30px, #0a0a0a 30px, #0a0a0a 60px); z-index: 0; border-top: 5px solid #000;}
        .desk { position: absolute; bottom: -10%; left: 30vw; width: 100vw; height: 40%; background: #221510; border-top: 15px solid #110906; box-shadow: 0 -20px 50px rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: flex-start; padding-top: 20px; z-index: 2;}
        .fan { font-size: 60px; margin-right: 50px; animation: spin 0.15s linear infinite; filter: brightness(0.6); }
        .desk-monitor { width: 120px; height: 90px; background: #0a0a0a; border: 5px solid #222; border-radius: 5px; box-shadow: inset 0 0 15px #000; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Hallways & Doors */
        .hallway { width: 25vw; height: 100%; background: #0f0f0f; position: relative; border-left: 10px solid #1a1a1a; border-right: 10px solid #1a1a1a; display: flex; align-items: center; justify-content: center; z-index: 1;}
        .door { position: absolute; top: 0; width: 100%; height: 100%; background: repeating-linear-gradient(0deg, #333, #333 10px, #1a1a1a 10px, #1a1a1a 20px); transform: translateY(-100%); transition: transform 0.3s ease; border-bottom: 15px solid #444; box-shadow: inset 0 -10px 20px rgba(0,0,0,0.8);}
        .door.closed { transform: translateY(0); }
        .light-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, rgba(200, 200, 150, 0.45) 0%, rgba(0, 0, 0, 0.8) 80%); opacity: 0; transition: opacity 0.1s; pointer-events: none;}
        .light-overlay.active { opacity: 1; }
        
        #right-window { position: absolute; top: 20%; right: 32vw; width: 100px; height: 150px; background: #050505; border: 5px solid #222; z-index: 1; overflow: hidden; box-shadow: inset 0 0 30px #000;}
        #window-character { font-size: 80px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; filter: drop-shadow(0 0 10px rgba(255,0,0,0.5)); }

        .control-panel { position: absolute; top: 50%; width: 70px; height: 140px; background: linear-gradient(to bottom, #333, #111); border: 2px solid #000; border-radius: 10px; transform: translateY(-50%); display: flex; flex-direction: column; justify-content: space-around; align-items: center; pointer-events: auto; z-index: 5; box-shadow: 5px 5px 15px rgba(0,0,0,0.9);}
        .left-panel { left: 26vw; } .right-panel { right: 26vw; }
        .btn { width: 45px; height: 45px; border-radius: 5px; cursor: pointer; border: 3px solid #000; transition: 0.1s;}
        .btn-door { background: #6a0000; } .btn-door.active { background: #ff3333; box-shadow: 0 0 15px #ff0000;}
        .btn-light { background: #776600; } .btn-light.active { background: #ffff66; box-shadow: 0 0 15px #ffff00;}

        /* C∆† CH·∫æ M·ªöI: H√¨nh ·∫£nh Animatronic & Hi·ªáu ·ª©ng Freddy Nh·∫•p nh√°y */
        .animatronic-door { position: absolute; font-size: 80px; display: none; filter: drop-shadow(0 0 20px #000) brightness(0.6);}
        .freddy-flashing { display: block !important; animation: freddy-flash 1s infinite alternate step-end; z-index: 100;}
        @keyframes freddy-flash {
            0%, 49% { opacity: 0; filter: drop-shadow(0 0 0px transparent); }
            50%, 100% { opacity: 1; filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.8)); }
        }

        /* C∆† CH·∫æ M·ªöI: Golden Freddy trong vƒÉn ph√≤ng */
        #golden-freddy-office { position: absolute; bottom: 5%; left: 45%; font-size: 150px; display: none; filter: sepia(1) hue-rotate(15deg) saturate(3) drop-shadow(0 0 20px rgba(255,215,0,0.5)); z-index: 3;}
        
        #camera-system { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.95), rgba(0,0,0,0.95) 2px, rgba(255,255,255,0.02) 2px, rgba(255,255,255,0.02) 4px); z-index: 60; display: none; pointer-events: auto;}
        #cam-view { position: absolute; top: 5%; left: 5%; width: 65%; height: 75%; border: 3px solid #777; display: flex; justify-content: center; align-items: center; background: #0a0a0a; box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative; overflow: hidden;}
        .cam-noise { position: absolute; top:0; left:0; width: 100%; height: 100%; background: url('data:image/svg+xml,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.85" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)" opacity="0.15"/%3E%3C/svg%3E'); pointer-events: none; }
        #cam-label { position: absolute; top: 20px; left: 20px; font-size: 24px; z-index: 2; color: #fff;}
        #cam-ai-visual { font-size: 120px; filter: grayscale(80%) brightness(0.7); z-index: 1; text-shadow: 0 0 30px #000; transition: 0.3s;}

        #map { position: absolute; bottom: 80px; right: 40px; width: 280px; height: 320px; border: 2px solid #555; background: rgba(0,0,0,0.7); pointer-events: auto;}
        .cam-btn { position: absolute; background: rgba(30,30,30,0.8); color: #888; border: 1px solid #666; cursor: pointer; font-size: 14px; width: 55px; height: 40px; text-align: center; transition: 0.1s; display: flex; justify-content: center; align-items: center;}
        .cam-btn:hover, .cam-btn.active { background: #ddd; color: #000; font-weight: bold; border-color: white;}
        #cam-1A { top: 20px; left: 110px; } #cam-1B { top: 70px; left: 110px; } #cam-5  { top: 70px; left: 45px; } 
        #cam-3  { top: 160px; left: 15px; } #cam-2A { top: 160px; left: 80px; } #cam-2B { top: 215px; left: 80px; } 
        #cam-4A { top: 160px; left: 175px; } #cam-4B { top: 215px; left: 175px; } 
        .you-are-here { position: absolute; bottom: 15px; left: 107px; width: 60px; height: 25px; background: #111; border: 2px solid #600; color: #d00; font-size: 11px; display: flex; justify-content: center; align-items: center; font-weight: bold;}

        /* Jumpscare & End Screens */
        #jumpscare, #gf-jumpscare, #game-over, #win-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 200; display: none; justify-content: center; align-items: center; font-size: 50px; flex-direction: column;}
        #jumpscare-icon { display: inline-block; filter: drop-shadow(0 0 50px red) contrast(150%); animation: jump-zoom 0.5s cubic-bezier(0.1, 0, 0, 1) forwards, fast-shake 0.05s infinite; }
        
        /* C∆† CH·∫æ M·ªöI: Golden Freddy Jumpscare (Tƒ©nh, L·ªõn, L·ªói game) */
        #gf-jumpscare-icon { font-size: 300px; filter: sepia(1) hue-rotate(15deg) saturate(3) drop-shadow(0 0 50px gold); }

        @keyframes jump-zoom { 0% { transform: scale(0.1) translateY(50px); opacity: 0; } 100% { transform: scale(5) translateY(0); opacity: 1; } }
        @keyframes fast-shake { 0%, 100% { margin-left: 0; margin-top: 0; } 25% { margin-left: 15px; margin-top: -15px; } 50% { margin-left: -15px; margin-top: 15px; } 75% { margin-left: 15px; margin-top: 15px; } }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>NIGHT SHIFT</h1>
        <div id="start-night-display">Night 1</div>
        <button class="menu-btn" onclick="initGame()">B·∫ÆT ƒê·∫¶U</button>
        <button class="menu-btn" onclick="resetData()" style="font-size: 14px; width: 150px; border-color: #400; color: #844;">X√≥a D·ªØ Li·ªáu</button>
    </div>

    <div id="vignette"></div>
    <div id="static-overlay"></div>

    <div id="viewport">
        <div id="office">
            <div class="wall-texture"></div>
            <div class="floor"></div>
            
            <div class="hallway" id="left-hall">
                <div class="door" id="door-left"></div>
                <div class="light-overlay" id="light-left-overlay"></div>
                <div class="animatronic-door" id="ai-left-visual">üê∞</div> </div>
            
            <div class="control-panel left-panel">
                <div class="btn btn-door" id="btn-door-left" onclick="toggleDoor('left')"></div>
                <div class="btn btn-light" id="btn-light-left" onmousedown="toggleLight('left', true)" onmouseup="toggleLight('left', false)" onmouseleave="toggleLight('left', false)"></div>
            </div>

            <div id="right-window"><div id="window-character">üêî</div></div>
            
            <div id="golden-freddy-office">üêª</div>

            <div class="desk">
                <div class="fan">‚ùÑÔ∏è</div>
                <div class="desk-monitor"></div>
                <div class="desk-monitor"></div>
            </div>

            <div class="control-panel right-panel">
                <div class="btn btn-door" id="btn-door-right" onclick="toggleDoor('right')"></div>
                <div class="btn btn-light" id="btn-light-right" onmousedown="toggleLight('right', true)" onmouseup="toggleLight('right', false)" onmouseleave="toggleLight('right', false)"></div>
            </div>

            <div class="hallway" id="right-hall">
                <div class="door" id="door-right"></div>
                <div class="light-overlay" id="light-right-overlay"></div>
                <div class="animatronic-door" id="ai-right-visual">üêî</div>
            </div>
        </div>
    </div>

    <div id="hud">
        <div class="top-right">
            <div id="time-display">12:00 AM</div>
            <div id="night-display">Night 1</div>
        </div>
        <div class="bottom-left">
            <div style="color: #aaa;">Power: <span id="power-display" style="color: white;">100%</span></div>
            <div style="color: #aaa;">Usage: <span id="usage-display">üîã</span></div>
        </div>
        <button id="cam-toggle" onclick="toggleCameras()">M·ªü Monitor</button>
    </div>

    <div id="camera-system">
        <div id="cam-view">
            <div class="cam-noise"></div>
            <div id="cam-label">CAM 1A - Show Stage</div>
            <div id="cam-ai-visual"></div>
        </div>
        <div id="map">
            <div class="cam-btn active" id="cam-1A" onclick="switchCam('1A', 'Show Stage')">1A</div>
            <div class="cam-btn" id="cam-1B" onclick="switchCam('1B', 'Dining Area')">1B</div>
            <div class="cam-btn" id="cam-5" onclick="switchCam('5', 'Backstage')">5</div>
            <div class="cam-btn" id="cam-2A" onclick="switchCam('2A', 'West Hall')">2A</div>
            <div class="cam-btn" id="cam-2B" onclick="switchCam('2B', 'W. Hall Corner')">2B</div>
            <div class="cam-btn" id="cam-3" onclick="switchCam('3', 'Supply Closet')">3</div>
            <div class="cam-btn" id="cam-4A" onclick="switchCam('4A', 'East Hall')">4A</div>
            <div class="cam-btn" id="cam-4B" onclick="switchCam('4B', 'E. Hall Corner')">4B</div>
            <div class="you-are-here">OFFICE</div>
        </div>
    </div>

    <div id="jumpscare"><div id="jumpscare-icon"></div></div>
    <div id="gf-jumpscare"><div id="gf-jumpscare-icon">üêª</div></div>
    
    <div id="game-over">GAME OVER<br><button onclick="location.reload()" style="padding: 10px; font-size:20px; margin-top: 20px; cursor: pointer; background:#222; color:white; border:2px solid white;">Th·ª≠ L·∫°i ƒê√™m N√†y</button></div>
    <div id="win-screen">
        <span id="win-text">6:00 AM</span><br>
        <span id="win-subtext" style="font-size:30px;">YOU SURVIVED</span><br>
        <button onclick="location.reload()" style="padding: 10px; font-size:20px; margin-top: 20px; cursor: pointer; background:white; color:black;">Ch∆°i Ti·∫øp</button>
    </div>

<script>
    // --- 1. LOCAL STORAGE ---
    let savedNight = parseInt(localStorage.getItem('fnaf_web_night')) || 1;
    if (savedNight > 5) savedNight = 5; 
    document.getElementById('start-night-display').innerText = `ƒê√™m ${savedNight}`;
    document.getElementById('night-display').innerText = `Night ${savedNight}`;

    function resetData() {
        if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu (Quay v·ªÅ ƒê√™m 1)?")) {
            localStorage.removeItem('fnaf_web_night'); location.reload();
        }
    }

    // --- 2. AUDIO SYSTEM ---
    let audioCtx;
    let droneOsc;
    let freddyMusicInterval;
    let gfHallucinationOsc;
    
    function initAudio() {
        if(!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            droneOsc = audioCtx.createOscillator();
            let gainNode = audioCtx.createGain();
            droneOsc.type = 'sine'; droneOsc.frequency.setValueAtTime(40, audioCtx.currentTime); 
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            droneOsc.connect(gainNode); gainNode.connect(audioCtx.destination);
            droneOsc.start();
        } else if (audioCtx.state === 'suspended') { audioCtx.resume(); }
    }

    const toreadorNotes = [349.23, 349.23, 349.23, 293.66, 233.08, 293.66, 261.63, 261.63, 261.63, 220.00, 261.63, 293.66];
    function playFreddyMusicBox() {
        if(!audioCtx) return; let noteIdx = 0;
        freddyMusicInterval = setInterval(() => {
            let osc = audioCtx.createOscillator(); let gain = audioCtx.createGain();
            osc.type = 'sine'; osc.frequency.value = toreadorNotes[noteIdx];
            osc.connect(gain); gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
            osc.start(); osc.stop(audioCtx.currentTime + 0.4);
            noteIdx = (noteIdx + 1) % toreadorNotes.length;
        }, 500); 
    }

    function playSound(type) {
        if(!audioCtx) return;
        let osc = audioCtx.createOscillator(); let gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        
        if (type === 'click' || type === 'door' || type === 'light') {
            // R√∫t g·ªçn c√°c h√†m c∆° b·∫£n (v·∫´n gi·ªØ nguy√™n logic c≈©)
            osc.type = type==='click'?'square':(type==='door'?'triangle':'sawtooth');
            let freq = type==='click'?400:(type==='door'?100:60);
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(type==='door'?0.5:0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        } else if (type === 'jumpscare') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 1.5);
            let osc2 = audioCtx.createOscillator(); osc2.type = 'square';
            osc2.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc2.connect(gain); osc2.start(); osc2.stop(audioCtx.currentTime + 2);
            gain.gain.setValueAtTime(1, audioCtx.currentTime); 
            osc.start(); osc.stop(audioCtx.currentTime + 2);
        } else if (type === 'gf-hallucination') {
            // √Çm thanh tr·∫ßm u √°m khi Golden Freddy xu·∫•t hi·ªán
            gfHallucinationOsc = audioCtx.createOscillator();
            gfHallucinationOsc.type = 'square'; gfHallucinationOsc.frequency.setValueAtTime(20, audioCtx.currentTime);
            let distGain = audioCtx.createGain(); distGain.gain.setValueAtTime(2, audioCtx.currentTime);
            gfHallucinationOsc.connect(distGain); distGain.connect(audioCtx.destination);
            gfHallucinationOsc.start();
        } else if (type === 'gf-crash') {
            // √Çm thanh ch√≥i tai l√†m crash game
            osc.type = 'square'; osc.frequency.setValueAtTime(50, audioCtx.currentTime);
            gain.gain.setValueAtTime(2, audioCtx.currentTime); // C·ª±c to
            osc.start(); osc.stop(audioCtx.currentTime + 3);
        }
    }

    // --- 3. GAME LOGIC ---
    let state = { power: 100, timeHour: 12, night: savedNight, isCamOpen: false, doors: { left: false, right: false }, lights: { left: false, right: false }, currentCam: '1A', isPowerOut: false, gameActive: false, gfActive: false };
    let timeInSeconds = 0; const SECONDS_PER_HOUR = 45; 
    let gameLoop, aiLoop, gfTimeout;

    const AI_LIST = [
        { name: 'Bonnie', icon: 'üê∞', side: 'left', position: 5, path: ['1A', '1B', '5', '2A', '2B', 'left_door'], level: 2 + savedNight },
        { name: 'Chica', icon: 'üêî', side: 'right', position: 4, path: ['1A', '1B', '4A', '4B', 'right_door'], level: 1 + savedNight }
    ];

    function initGame() {
        document.getElementById('start-screen').style.display = 'none'; initAudio();
        state.gameActive = true;
        gameLoop = setInterval(gameTimerLoop, 1000); aiLoop = setInterval(updateAI, 3000);
        updateCamVisuals();
    }

    const office = document.getElementById('office'); let officeX = -30; 
    document.addEventListener('mousemove', (e) => {
        if(state.isCamOpen || !state.gameActive || state.isPowerOut || e.target.id === 'cam-toggle') return;
        const mouseX = e.clientX; const width = window.innerWidth; const panSpeed = 1.5;
        if (mouseX < width * 0.25) officeX += panSpeed; else if (mouseX > width * 0.75) officeX -= panSpeed;
        if (officeX > 0) officeX = 0; if (officeX < -60) officeX = -60; 
        office.style.transform = `translateX(${officeX}vw)`;
    });

    function updateUsageDisplay() {
        let usage = 1; 
        if(state.doors.left) usage++; if(state.doors.right) usage++;
        if(state.lights.left) usage++; if(state.lights.right) usage++;
        if(state.isCamOpen) usage++;
        let batteryBars = ""; for(let i=0; i<usage; i++) batteryBars += "üîã";
        document.getElementById('usage-display').innerText = batteryBars; return usage;
    }

    function toggleDoor(side) {
        if(state.isPowerOut || !state.gameActive) return;
        playSound('door'); state.doors[side] = !state.doors[side];
        document.getElementById(`door-${side}`).classList.toggle('closed');
        document.getElementById(`btn-door-${side}`).classList.toggle('active');
        updateUsageDisplay();
    }

    function toggleLight(side, isTurnOn) {
        if(state.isPowerOut || !state.gameActive) return;
        if(isTurnOn) playSound('light'); state.lights[side] = isTurnOn;
        const overlay = document.getElementById(`light-${side}-overlay`);
        const btn = document.getElementById(`btn-light-${side}`);
        if(isTurnOn) { overlay.classList.add('active'); btn.classList.add('active'); } 
        else { overlay.classList.remove('active'); btn.classList.remove('active'); }
        updateDoorVisuals(side); updateUsageDisplay();
    }

    function updateDoorVisuals(side) {
        const aiAtDoor = AI_LIST.find(ai => ai.side === side && ai.position === 0);
        const visual = document.getElementById(`ai-${side}-visual`);
        const winChar = document.getElementById('window-character');
        
        if(state.lights[side] && aiAtDoor) {
            visual.innerText = aiAtDoor.icon; visual.style.display = 'block';
            if(side === 'right') { winChar.innerText = aiAtDoor.icon; winChar.style.display = 'block'; }
        } else {
            visual.style.display = 'none'; if(side === 'right') winChar.style.display = 'none';
        }
    }

    // --- GOLDEN FREDDY MECHANIC ---
    function triggerGoldenFreddy() {
        state.gfActive = true;
        document.getElementById('golden-freddy-office').style.display = 'block';
        playSound('gf-hallucination');
        
        // B·∫°n c√≥ 2 gi√¢y ƒë·ªÉ b·∫≠t l·∫°i m√†n h√¨nh, n·∫øu kh√¥ng...
        gfTimeout = setTimeout(() => {
            if (state.gfActive && !state.isCamOpen) {
                executeGoldenFreddyJumpscare();
            }
        }, 2000);
    }

    function cancelGoldenFreddy() {
        state.gfActive = false;
        document.getElementById('golden-freddy-office').style.display = 'none';
        clearTimeout(gfTimeout);
        if(gfHallucinationOsc) { gfHallucinationOsc.stop(); gfHallucinationOsc = null; }
    }

    function executeGoldenFreddyJumpscare() {
        state.gameActive = false;
        clearInterval(gameLoop); clearInterval(aiLoop);
        if(gfHallucinationOsc) { gfHallucinationOsc.stop(); gfHallucinationOsc = null; }
        playSound('gf-crash');
        
        document.getElementById('camera-system').style.display = 'none';
        document.getElementById('static-overlay').classList.add('heavy-static');
        document.getElementById('gf-jumpscare').style.display = 'flex';
        
        // T√°i t·∫°o c·∫£m gi√°c Game Crash: ƒê·ª©ng h√¨nh 3 gi√¢y r·ªìi reload trang
        setTimeout(() => {
            location.reload(); 
        }, 3000);
    }

    function toggleCameras() {
        if(state.isPowerOut || !state.gameActive) return;
        playSound('click'); 
        state.isCamOpen = !state.isCamOpen;
        
        if (!state.isCamOpen) {
            // V·ª´a H·∫† camera xu·ªëng: C√≥ t·ªâ l·ªá nh·ªè xu·∫•t hi·ªán Golden Freddy (5% cho d·ªÖ test)
            if (Math.random() < 0.05 && !state.gfActive) {
                triggerGoldenFreddy();
            }
        } else {
            // V·ª´a M·ªû camera l√™n: Tho√°t kh·ªèi GF n·∫øu h·∫Øn ƒëang ·ªü ƒë√≥
            if (state.gfActive) cancelGoldenFreddy();
        }

        document.getElementById('camera-system').style.display = state.isCamOpen ? 'block' : 'none';
        document.getElementById('cam-toggle').innerText = state.isCamOpen ? "ƒê√≥ng Monitor" : "M·ªü Monitor";
        updateUsageDisplay(); updateCamVisuals();
    }

    function switchCam(id, name) {
        playSound('click'); state.currentCam = id;
        document.getElementById('cam-label').innerText = `CAM ${id} - ${name}`;
        document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`cam-${id}`).classList.add('active');
        updateCamVisuals();
    }

    function updateAI() {
        if(!state.gameActive || state.isPowerOut) return;
        AI_LIST.forEach(ai => {
            let moveRoll = Math.floor(Math.random() * 20) + 1; 
            if(moveRoll <= ai.level) {
                if(ai.position > 0) { ai.position--; } 
                else if (ai.position === 0) {
                    if (state.doors[ai.side]) { ai.position = Math.floor(Math.random() * 2) + 1; } 
                    else { triggerJumpscare(ai.icon); }
                }
            }
        });
        updateCamVisuals(); updateDoorVisuals('left'); updateDoorVisuals('right');
    }

    function updateCamVisuals() {
        if(!state.isCamOpen) return;
        let iconsToDisplay = [];
        AI_LIST.forEach(ai => {
            let currentRoomOfAI = ai.path[ai.path.length - 1 - ai.position];
            if(ai.position === ai.path.length - 1) currentRoomOfAI = '1A';
            if(currentRoomOfAI === state.currentCam) iconsToDisplay.push(ai.icon);
        });
        document.getElementById('cam-ai-visual').innerText = iconsToDisplay.join(" ");
    }

    function triggerJumpscare(icon) {
        state.gameActive = false;
        clearInterval(gameLoop); clearInterval(aiLoop);
        if(freddyMusicInterval) clearInterval(freddyMusicInterval); 
        playSound('jumpscare');
        
        document.getElementById('camera-system').style.display = 'none';
        const jumpScreen = document.getElementById('jumpscare');
        document.getElementById('jumpscare-icon').innerText = icon;
        jumpScreen.style.display = 'none'; void jumpScreen.offsetWidth; 
        jumpScreen.style.display = 'flex';
        
        setTimeout(() => {
            jumpScreen.style.display = 'none';
            document.getElementById('game-over').style.display = 'flex';
        }, 1500); 
    }

    function gameTimerLoop() {
        if(!state.gameActive) return;
        timeInSeconds++;
        if (timeInSeconds >= SECONDS_PER_HOUR) {
            timeInSeconds = 0; state.timeHour++;
            if(state.timeHour === 13) state.timeHour = 1;
            document.getElementById('time-display').innerText = `${state.timeHour}:00 AM`;
            AI_LIST.forEach(ai => ai.level++); 
            
            if (state.timeHour === 6) {
                state.gameActive = false;
                clearInterval(gameLoop); clearInterval(aiLoop);
                if(state.night < 5) {
                    localStorage.setItem('fnaf_web_night', state.night + 1);
                    document.getElementById('win-subtext').innerText = `YOU SURVIVED NIGHT ${state.night}`;
                } else {
                    document.getElementById('win-subtext').innerText = `YOU BEAT NIGHT 5!`;
                }
                document.getElementById('win-screen').style.display = 'flex'; return;
            }
        }
        if (!state.isPowerOut) {
            let drainRate = updateUsageDisplay() * 0.15; state.power -= drainRate;
            if (state.power <= 0) { state.power = 0; triggerPowerOut(); }
            let rColor = state.power < 20 ? 'red' : 'white';
            document.getElementById('power-display').innerHTML = `<span style="color:${rColor}">${Math.floor(state.power)}%</span>`;
        }
    }

    // --- FREDDY POWER OUT MECHANIC ---
    function triggerPowerOut() {
        state.isPowerOut = true; state.isCamOpen = false;
        document.getElementById('camera-system').style.display = 'none';
        document.getElementById('cam-toggle').style.display = 'none';
        if(state.gfActive) cancelGoldenFreddy(); // X√≥a GF n·∫øu ƒëang c√≥
        
        playSound('door'); 
        ['left', 'right'].forEach(side => {
            state.doors[side] = false;
            document.getElementById(`door-${side}`).classList.remove('closed');
            document.getElementById(`btn-door-${side}`).classList.remove('active');
            toggleLight(side, false);
        });
        
        document.getElementById('office').style.background = '#000';
        document.getElementById('vignette').style.background = 'rgba(0,0,0,0.95)';
        document.querySelector('.wall-texture').style.opacity = '0';
        document.getElementById('window-character').style.display = 'none'; 
        if(droneOsc) { droneOsc.stop(); droneOsc = null; } 
        
        // 1. Giai ƒëo·∫°n 1: Freddy nh·∫•p nh√°y ·ªü c·ª≠a tr√°i + H√°t
        const freddyFace = document.getElementById('ai-left-visual');
        freddyFace.innerText = 'üêª';
        freddyFace.className = 'animatronic-door freddy-flashing'; // CSS nh·∫•p nh√°y
        playFreddyMusicBox();
        
        let musicDuration = 5000 + Math.random() * 7000;
        
        setTimeout(() => {
            // 2. Giai ƒëo·∫°n 2: Nh·∫°c d·ª©t, m·ªçi th·ª© ch√¨m v√†o b√≥ng t·ªëi
            clearInterval(freddyMusicInterval);
            freddyFace.className = 'animatronic-door'; 
            freddyFace.style.display = 'none'; // ƒêen ƒë·∫∑c
            
            // 3. Kho·∫£ng l·∫∑ng im ch·∫øt ch√≥c (delay 2-5 gi√¢y)
            setTimeout(() => {
                triggerJumpscare('üêª');
            }, 2000 + Math.random() * 3000);
            
        }, musicDuration);
    }
</script>
</body>
</html>