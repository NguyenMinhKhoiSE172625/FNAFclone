<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Night Shift - Prototype V5</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; color: white; font-family: 'Courier New', Courier, monospace; user-select: none; }
        
        #vignette { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, transparent 30%, rgba(0,0,0,0.95) 90%); pointer-events: none; z-index: 40; }
        #static-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('data:image/svg+xml,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)" opacity="0.05"/%3E%3C/svg%3E'); pointer-events: none; z-index: 41; opacity: 0.5;}

        /* Start Screen */
        #start-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 200; display: flex; justify-content: center; align-items: center; flex-direction: column; cursor: pointer; }
        #start-screen h1 { font-size: 50px; color: #a00; text-shadow: 0 0 10px red; }
        #start-screen p { font-size: 20px; color: #555; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* HUD & Monitor Toggle (ƒê√É S·ª¨A: CHUY·ªÇN RA GI·ªÆA) */
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .top-right { position: absolute; top: 20px; right: 30px; text-align: right; font-size: 24px; text-shadow: 2px 2px 0 #000; }
        .bottom-left { position: absolute; bottom: 30px; left: 30px; font-size: 20px; text-shadow: 2px 2px 0 #000; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px;}
        #dialogue-box { position: absolute; top: 20px; left: 20px; width: 300px; background: rgba(0,0,0,0.8); border: 2px solid #555; padding: 15px; font-size: 14px; display: none; pointer-events: auto; box-shadow: 0 0 10px #000;}
        
        #cam-toggle { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 400px; height: 40px; background: rgba(255,255,255,0.1); border: 2px solid #555; border-bottom: none; color: #aaa; cursor: pointer; pointer-events: auto; font-size: 18px; transition: 0.2s; border-radius: 10px 10px 0 0;}
        #cam-toggle:hover { background: rgba(255,255,255,0.3); color: white; height: 45px;}

        /* Office */
        #viewport { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        #office { position: absolute; top: 0; left: 0; width: 160vw; height: 100%; background: linear-gradient(to right, #020202, #0d0d0d, #0d0d0d, #020202); transition: transform 0.1s ease-out; display: flex; justify-content: space-between; align-items: center;}
        
        .wall-texture { position: absolute; width: 100%; height: 80%; top: 0; background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.2) 0px, rgba(0,0,0,0.2) 2px, transparent 2px, transparent 4px); pointer-events: none; opacity: 0.3;}
        .floor { position: absolute; bottom: 0; left: 0; width: 100%; height: 20%; background: repeating-linear-gradient(45deg, #111, #111 30px, #050505 30px, #050505 60px); z-index: 0; border-top: 5px solid #000;}
        
        .desk { position: absolute; bottom: -10%; left: 30vw; width: 100vw; height: 40%; background: #1a0f0a; border-top: 15px solid #0d0705; box-shadow: 0 -20px 50px rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: flex-start; padding-top: 20px; z-index: 2;}
        .fan { font-size: 60px; margin-right: 50px; animation: spin 0.15s linear infinite; filter: brightness(0.5); }
        .desk-monitor { width: 120px; height: 90px; background: #050505; border: 5px solid #222; border-radius: 5px; box-shadow: inset 0 0 15px #000; }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Hallways & Doors */
        .hallway { width: 25vw; height: 100%; background: #000; position: relative; border-left: 10px solid #050505; border-right: 10px solid #050505; display: flex; align-items: center; justify-content: center; z-index: 1;}
        .door { position: absolute; top: 0; width: 100%; height: 100%; background: repeating-linear-gradient(0deg, #111, #111 10px, #050505 10px, #050505 20px); transform: translateY(-100%); transition: transform 0.3s ease; border-bottom: 10px solid #222;}
        .door.closed { transform: translateY(0); }
        
        .light-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, rgba(200, 200, 150, 0.4) 0%, rgba(0, 0, 0, 0.9) 80%); opacity: 0; transition: opacity 0.1s; pointer-events: none;}
        .light-overlay.active { opacity: 1; }
        
        #right-window { position: absolute; top: 20%; right: 32vw; width: 100px; height: 150px; background: #000; border: 5px solid #111; z-index: 1; overflow: hidden; box-shadow: inset 0 0 30px #000;}
        #window-character { font-size: 80px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; filter: drop-shadow(0 0 10px rgba(255,0,0,0.5)); }

        .control-panel { position: absolute; top: 50%; width: 70px; height: 140px; background: linear-gradient(to bottom, #222, #050505); border: 2px solid #000; border-radius: 10px; transform: translateY(-50%); display: flex; flex-direction: column; justify-content: space-around; align-items: center; pointer-events: auto; z-index: 5; box-shadow: 5px 5px 15px rgba(0,0,0,0.9);}
        .left-panel { left: 26vw; } .right-panel { right: 26vw; }
        .btn { width: 45px; height: 45px; border-radius: 5px; cursor: pointer; border: 3px solid #000; transition: 0.1s;}
        .btn-door { background: #5a0000; } .btn-door.active { background: #ff2222; box-shadow: 0 0 15px #ff0000;}
        .btn-light { background: #665500; } .btn-light.active { background: #ffff55; box-shadow: 0 0 15px #ffff00;}

        .animatronic-door { position: absolute; font-size: 80px; display: none; filter: drop-shadow(0 0 20px #000) brightness(0.6);}

        /* Camera UI */
        #camera-system { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.95), rgba(0,0,0,0.95) 2px, rgba(255,255,255,0.02) 2px, rgba(255,255,255,0.02) 4px); z-index: 60; display: none; pointer-events: auto;}
        #cam-view { position: absolute; top: 5%; left: 5%; width: 60%; height: 70%; border: 3px solid #555; display: flex; justify-content: center; align-items: center; background: #050505; box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative; overflow: hidden;}
        .cam-noise { position: absolute; top:0; left:0; width: 100%; height: 100%; background: url('data:image/svg+xml,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.85" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)" opacity="0.15"/%3E%3C/svg%3E'); pointer-events: none; }
        #cam-label { position: absolute; top: 20px; left: 20px; font-size: 24px; z-index: 2; color: #fff;}
        #cam-ai-visual { font-size: 120px; filter: grayscale(80%) brightness(0.7); z-index: 1; text-shadow: 0 0 30px #000; transition: 0.3s;}

        /* ƒê√É S·ª¨A: Map ƒë∆∞·ª£c c·ªë ƒë·ªãnh c·ª©ng g√≥c ph·∫£i b·∫±ng px, tr√°nh v·ª° layout */
        #map { position: absolute; bottom: 60px; right: 40px; width: 320px; height: 320px; border: 2px solid #555; background: rgba(0,0,0,0.8); pointer-events: auto;}
        .cam-btn { position: absolute; background: rgba(20,20,20,0.8); color: #777; border: 1px solid #555; cursor: pointer; font-size: 14px; width: 55px; height: 40px; text-align: center; transition: 0.1s;}
        .cam-btn:hover, .cam-btn.active { background: #aaa; color: #000; font-weight: bold; border-color: white;}
        
        #cam-1A { top: 5%; left: 40%; } #cam-1B { top: 25%; left: 40%; } #cam-5  { top: 25%; left: 10%; }
        #cam-2A { top: 60%; left: 25%; } #cam-2B { top: 80%; left: 25%; } #cam-3  { top: 60%; left: 5%; }
        #cam-4A { top: 60%; left: 60%; } #cam-4B { top: 80%; left: 60%; }
        .you-are-here { position: absolute; bottom: -15px; left: 40%; width: 60px; height: 25px; background: #111; border: 2px solid #500; color: #a00; font-size: 10px; display: flex; justify-content: center; align-items: center; text-align: center;}

        /* ƒê√É S·ª¨A: C·∫£i ti·∫øn Jumpscare Animation (Lao th·∫≥ng v√†o m·∫∑t) */
        #jumpscare, #game-over, #win-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 200; display: none; justify-content: center; align-items: center; font-size: 50px; flex-direction: column;}
        
        #jumpscare-icon {
            display: inline-block;
            filter: drop-shadow(0 0 50px red) contrast(150%);
            /* K·∫øt h·ª£p zoom nhanh v√† l·∫Øc gi·∫≠t */
            animation: jump-zoom 0.5s cubic-bezier(0.1, 0, 0, 1) forwards, fast-shake 0.05s infinite;
        }

        @keyframes jump-zoom {
            0% { transform: scale(0.1) translateY(50px); opacity: 0; }
            100% { transform: scale(5) translateY(0); opacity: 1; }
        }

        @keyframes fast-shake {
            0%, 100% { margin-left: 0; margin-top: 0; }
            25% { margin-left: 15px; margin-top: -15px; }
            50% { margin-left: -15px; margin-top: 15px; }
            75% { margin-left: 15px; margin-top: 15px; }
        }
    </style>
</head>
<body>

    <div id="start-screen" onclick="initGame()">
        <h1>NIGHT SHIFT</h1>
        <p>Click to Start</p>
    </div>

    <div id="vignette"></div>
    <div id="static-overlay"></div>

    <div id="viewport">
        <div id="office">
            <div class="wall-texture"></div>
            <div class="floor"></div>
            
            <div class="hallway" id="left-hall">
                <div class="door" id="door-left"></div>
                <div class="light-overlay" id="light-left-overlay"></div>
                <div class="animatronic-door" id="ai-left-visual">üê∞</div>
            </div>
            
            <div class="control-panel left-panel">
                <div class="btn btn-door" id="btn-door-left" onclick="toggleDoor('left')"></div>
                <div class="btn btn-light" id="btn-light-left" onmousedown="toggleLight('left', true)" onmouseup="toggleLight('left', false)" onmouseleave="toggleLight('left', false)"></div>
            </div>

            <div id="right-window"><div id="window-character">üêî</div></div>

            <div class="desk">
                <div class="fan">‚ùÑÔ∏è</div>
                <div class="desk-monitor"></div>
                <div class="desk-monitor"></div>
            </div>

            <div class="control-panel right-panel">
                <div class="btn btn-door" id="btn-door-right" onclick="toggleDoor('right')"></div>
                <div class="btn btn-light" id="btn-light-right" onmousedown="toggleLight('right', true)" onmouseup="toggleLight('right', false)" onmouseleave="toggleLight('right', false)"></div>
            </div>

            <div class="hallway" id="right-hall">
                <div class="door" id="door-right"></div>
                <div class="light-overlay" id="light-right-overlay"></div>
                <div class="animatronic-door" id="ai-right-visual">üêî</div>
            </div>
        </div>
    </div>

    <div id="hud">
        <div class="top-right">
            <div id="time-display">12:00 AM</div>
            <div id="night-display">Night 1</div>
        </div>
        <div class="bottom-left">
            <div style="color: #aaa;">Power: <span id="power-display" style="color: white;">100%</span></div>
            <div style="color: #aaa;">Usage: <span id="usage-display">üîã</span></div>
        </div>
        <div id="dialogue-box">
            <strong style="color:#aaa;">System:</strong><br><span id="dialogue-text"></span>
        </div>
        <button id="cam-toggle" onclick="toggleCameras()">M·ªü Monitor</button>
    </div>

    <div id="camera-system">
        <div id="cam-view">
            <div class="cam-noise"></div>
            <div id="cam-label">CAM 1A - Show Stage</div>
            <div id="cam-ai-visual"></div>
        </div>
        
        <div id="map">
            <button class="cam-btn active" id="cam-1A" onclick="switchCam('1A', 'Show Stage')">1A</button>
            <button class="cam-btn" id="cam-1B" onclick="switchCam('1B', 'Dining Area')">1B</button>
            <button class="cam-btn" id="cam-5" onclick="switchCam('5', 'Backstage')">5</button>
            <button class="cam-btn" id="cam-2A" onclick="switchCam('2A', 'West Hall')">2A</button>
            <button class="cam-btn" id="cam-2B" onclick="switchCam('2B', 'W. Hall Corner')">2B</button>
            <button class="cam-btn" id="cam-3" onclick="switchCam('3', 'Supply Closet')">3</button>
            <button class="cam-btn" id="cam-4A" onclick="switchCam('4A', 'East Hall')">4A</button>
            <button class="cam-btn" id="cam-4B" onclick="switchCam('4B', 'E. Hall Corner')">4B</button>
            <div class="you-are-here">OFFICE</div>
        </div>
    </div>

    <div id="jumpscare"><div id="jumpscare-icon"></div></div>
    <div id="game-over">GAME OVER<br><button onclick="location.reload()" style="padding: 10px; font-size:20px; margin-top: 20px; cursor: pointer; background:#222; color:white; border:2px solid white;">Ch∆°i L·∫°i</button></div>
    <div id="win-screen">6:00 AM<br>YOU SURVIVED<br><button onclick="location.reload()" style="padding: 10px; font-size:20px; margin-top: 20px; cursor: pointer;">Ch∆°i L·∫°i</button></div>

<script>
    // --- AUDIO SYSTEM ---
    let audioCtx;
    let droneOsc;
    
    function initAudio() {
        if(!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            droneOsc = audioCtx.createOscillator();
            let gainNode = audioCtx.createGain();
            droneOsc.type = 'sine';
            droneOsc.frequency.setValueAtTime(40, audioCtx.currentTime); 
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            droneOsc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            droneOsc.start();
        } else if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    function playSound(type) {
        if(!audioCtx) return;
        let osc = audioCtx.createOscillator();
        let gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        if (type === 'click') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        } else if (type === 'door') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(100, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(50, audioCtx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        } else if (type === 'light') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(60, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        } else if (type === 'jumpscare') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 1.5);
            
            let osc2 = audioCtx.createOscillator();
            osc2.type = 'square';
            osc2.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc2.connect(gain);
            osc2.start(); osc2.stop(audioCtx.currentTime + 2);
            
            gain.gain.setValueAtTime(1, audioCtx.currentTime); 
            osc.start(); osc.stop(audioCtx.currentTime + 2);
        }
    }

    // --- GAME LOGIC ---
    let state = { power: 100, timeHour: 12, night: 1, isCamOpen: false, doors: { left: false, right: false }, lights: { left: false, right: false }, currentCam: '1A', isPowerOut: false, gameActive: false };
    let timeInSeconds = 0; const SECONDS_PER_HOUR = 45; 
    let gameLoop, aiLoop;

    function initGame() {
        document.getElementById('start-screen').style.display = 'none';
        initAudio();
        state.gameActive = true;
        
        gameLoop = setInterval(gameTimerLoop, 1000);
        aiLoop = setInterval(updateAI, 3000);
        
        updateCamVisuals();
    }

    const office = document.getElementById('office');
    let officeX = -30; 
    document.addEventListener('mousemove', (e) => {
        // Ch·ªâ pan khi con tr·ªè KH√îNG n·∫±m tr√™n v√πng UI (n√∫t cam-toggle)
        if(state.isCamOpen || !state.gameActive || state.isPowerOut || e.target.id === 'cam-toggle') return;
        
        const mouseX = e.clientX; const width = window.innerWidth; const panSpeed = 1.5;
        if (mouseX < width * 0.25) officeX += panSpeed; else if (mouseX > width * 0.75) officeX -= panSpeed;
        if (officeX > 0) officeX = 0; if (officeX < -60) officeX = -60; 
        office.style.transform = `translateX(${officeX}vw)`;
    });

    function updateUsageDisplay() {
        let usage = 1; 
        if(state.doors.left) usage++; if(state.doors.right) usage++;
        if(state.lights.left) usage++; if(state.lights.right) usage++;
        if(state.isCamOpen) usage++;
        let batteryBars = ""; for(let i=0; i<usage; i++) batteryBars += "üîã";
        document.getElementById('usage-display').innerText = batteryBars; return usage;
    }

    function toggleDoor(side) {
        if(state.isPowerOut || !state.gameActive) return;
        playSound('door');
        state.doors[side] = !state.doors[side];
        document.getElementById(`door-${side}`).classList.toggle('closed');
        document.getElementById(`btn-door-${side}`).classList.toggle('active');
        updateUsageDisplay();
    }

    function toggleLight(side, isTurnOn) {
        if(state.isPowerOut || !state.gameActive) return;
        if(isTurnOn) playSound('light');
        state.lights[side] = isTurnOn;
        const overlay = document.getElementById(`light-${side}-overlay`);
        const btn = document.getElementById(`btn-light-${side}`);
        
        if(isTurnOn) {
            overlay.classList.add('active'); btn.classList.add('active');
        } else {
            overlay.classList.remove('active'); btn.classList.remove('active');
        }
        updateDoorVisuals(side); updateUsageDisplay();
    }

    function updateDoorVisuals(side) {
        const aiAtDoor = AI_LIST.find(ai => ai.side === side && ai.position === 0);
        const visual = document.getElementById(`ai-${side}-visual`);
        const winChar = document.getElementById('window-character');
        
        if(state.lights[side] && aiAtDoor) {
            visual.innerText = aiAtDoor.icon; visual.style.display = 'block';
            if(side === 'right') { winChar.innerText = aiAtDoor.icon; winChar.style.display = 'block'; }
        } else {
            visual.style.display = 'none';
            if(side === 'right') winChar.style.display = 'none';
        }
    }

    function toggleCameras() {
        if(state.isPowerOut || !state.gameActive) return;
        playSound('click');
        state.isCamOpen = !state.isCamOpen;
        document.getElementById('camera-system').style.display = state.isCamOpen ? 'block' : 'none';
        // ƒê·ªïi ch·ªØ tr√™n n√∫t Monitor
        document.getElementById('cam-toggle').innerText = state.isCamOpen ? "ƒê√≥ng Monitor" : "M·ªü Monitor";
        updateUsageDisplay(); updateCamVisuals();
    }

    function switchCam(id, name) {
        playSound('click');
        state.currentCam = id;
        document.getElementById('cam-label').innerText = `CAM ${id} - ${name}`;
        document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`cam-${id}`).classList.add('active');
        updateCamVisuals();
    }

    const AI_LIST = [
        { name: 'Bonnie', icon: 'üê∞', side: 'left', position: 5, path: ['1A', '1B', '5', '2A', '2B', 'left_door'], level: 3 },
        { name: 'Chica', icon: 'üêî', side: 'right', position: 4, path: ['1A', '1B', '4A', '4B', 'right_door'], level: 2 }
    ];

    function updateAI() {
        if(!state.gameActive || state.isPowerOut) return;
        AI_LIST.forEach(ai => {
            let moveRoll = Math.floor(Math.random() * 20) + 1; 
            if(moveRoll <= ai.level) {
                if(ai.position > 0) { ai.position--; } 
                else if (ai.position === 0) {
                    if (state.doors[ai.side]) { ai.position = Math.floor(Math.random() * 2) + 1; } 
                    else { triggerJumpscare(ai.icon); }
                }
            }
        });
        updateCamVisuals(); updateDoorVisuals('left'); updateDoorVisuals('right');
    }

    function updateCamVisuals() {
        if(!state.isCamOpen) return;
        let iconsToDisplay = [];
        AI_LIST.forEach(ai => {
            let currentRoomOfAI = ai.path[ai.path.length - 1 - ai.position];
            if(ai.position === ai.path.length - 1) currentRoomOfAI = '1A';
            if(currentRoomOfAI === state.currentCam) iconsToDisplay.push(ai.icon);
        });
        document.getElementById('cam-ai-visual').innerText = iconsToDisplay.join(" ");
    }

    function triggerJumpscare(icon) {
        state.gameActive = false;
        clearInterval(gameLoop); clearInterval(aiLoop);
        playSound('jumpscare');
        
        document.getElementById('camera-system').style.display = 'none';
        
        // Hi·ªán jumpscare v√† reset animation
        const jumpScreen = document.getElementById('jumpscare');
        const jumpIcon = document.getElementById('jumpscare-icon');
        jumpIcon.innerText = icon;
        
        // Force reflow ƒë·ªÉ ƒë·∫£m b·∫£o animation ch·∫°y l·∫°i m∆∞·ª£t m√†
        jumpScreen.style.display = 'none';
        void jumpScreen.offsetWidth; 
        jumpScreen.style.display = 'flex';
        
        setTimeout(() => {
            jumpScreen.style.display = 'none';
            document.getElementById('game-over').style.display = 'flex';
        }, 1500); // 1.5 gi√¢y nh·∫£y m·∫∑t
    }

    function gameTimerLoop() {
        if(!state.gameActive) return;
        timeInSeconds++;
        if (timeInSeconds >= SECONDS_PER_HOUR) {
            timeInSeconds = 0; state.timeHour++;
            if(state.timeHour === 13) state.timeHour = 1;
            document.getElementById('time-display').innerText = `${state.timeHour}:00 AM`;
            AI_LIST.forEach(ai => ai.level++);
            if (state.timeHour === 6) {
                state.gameActive = false;
                clearInterval(gameLoop); clearInterval(aiLoop);
                document.getElementById('win-screen').style.display = 'flex'; return;
            }
        }
        if (!state.isPowerOut) {
            let drainRate = updateUsageDisplay() * 0.15; state.power -= drainRate;
            if (state.power <= 0) { state.power = 0; triggerPowerOut(); }
            let rColor = state.power < 20 ? 'red' : 'white';
            document.getElementById('power-display').innerHTML = `<span style="color:${rColor}">${Math.floor(state.power)}%</span>`;
        }
    }

    function triggerPowerOut() {
        state.isPowerOut = true; state.isCamOpen = false;
        document.getElementById('camera-system').style.display = 'none';
        document.getElementById('cam-toggle').style.display = 'none'; // Gi·∫•u n√∫t monitor
        playSound('door'); 
        
        ['left', 'right'].forEach(side => {
            state.doors[side] = false;
            document.getElementById(`door-${side}`).classList.remove('closed');
            document.getElementById(`btn-door-${side}`).classList.remove('active');
            toggleLight(side, false);
        });
        
        document.getElementById('office').style.background = '#000';
        document.getElementById('vignette').style.background = 'rgba(0,0,0,0.95)';
        document.querySelector('.wall-texture').style.opacity = '0';
        document.getElementById('window-character').style.display = 'none'; 
        
        if(droneOsc) { droneOsc.stop(); droneOsc = null; } 
        
        setTimeout(() => { triggerJumpscare('üêª'); }, 5000 + Math.random() * 5000);
    }
</script>
</body>
</html>